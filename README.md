# 海龟交易策略回测框架

本项目是经典“海龟交易法则”（Turtle Trading）的一个完整 Python 实现和回测框架。它不仅包含了完整的策略逻辑、信号生成、头寸规模计算，还提供了一个事件驱动的回测引擎，可以对指定的股票应用海龟交易策略，并生成详细的绩效评估报告。

## 核心概念

海龟交易法是一套完整的、机械化的交易系统，其决策完全基于价格和波动性，不依赖任何主观判断。

- **入场规则**: 当价格突破过去20日的最高价时，建立多头头寸。反之，当价格跌破过去20日的最低价时，建立空头头寸。
- **出场规则**: 当多头头寸的价格跌破过去10日的最低价时，平仓。反之，当空头头寸的价格突破过去10日的最高价时，平仓。
- **止损规则**: 使用基于平均真实波幅（ATR）的动态止损来严格控制单笔亏损。
- **头寸规模管理**: 根据账户总资金和市场的波动性（ATR）来动态计算每笔交易的头寸大小（“Unit”），这是海龟法则风险管理的核心。

## ✨ 主要功能

- **策略实现**:
    - 完整实现了海龟交易法则的信号生成逻辑（基于唐奇安通道）。
    - 可灵活自定义唐奇安通道的入场（默认20日）和出场（默认10日）周期。
    - 可自定义ATR周期和用于计算止损的ATR倍数。
- **动态头寸规模**: 根据账户风险百分比（默认为1%）和ATR动态计算每个交易单位的大小。
- **多股票支持**: 支持同时对多个股票进行策略分析和回测。
- **事件驱动回测引擎**:
    - 一个简洁的回测器，逐日模拟交易过程，处理开仓、平仓和止损事件。
    - 支持自定义设置初始资金、交易手续费和滑点，使回测更贴近真实情况。
    - 详细记录每一笔交易，包括入场/出场时间、价格、持仓量、单笔盈亏等。
- **全面的绩效评估**:
    - 自动计算并展示丰富的行业标准绩效指标，包括：
        - **收益指标**: 总收益率、年化收益率。
        - **风险指标**: 最大回撤（Max Drawdown）。
        - **风险调整后收益**: 夏普比率（Sharpe Ratio）、索提诺比率（Sortino Ratio）、卡玛比率（Calmar Ratio）。
        - **交易统计**: 总交易次数、胜率、平均盈亏、盈亏比（Profit Factor）等。
- **单元测试**: 项目包含一套使用 `pytest` 编写的单元测试，覆盖了策略和回测引擎的核心功能，确保代码的健壮性和准确性。

## 项目结构

```
turtle_trading/
├── src/
│   ├── main.py             # 主程序入口，用于运行策略和回测
│   ├── turtle_trading_strategy.py # 海龟策略核心逻辑（信号、头寸计算）
│   ├── turtle_backtest.py  # 事件驱动回测引擎
│   └── data_utils.py       # 数据获取工具
├── tests/
│   ├── conftest.py         # Pytest 共享测试数据
│   ├── test_backtester.py  # 回测引擎的单元测试
│   └── test_strategy.py    # 策略逻辑的单元测试
├── requirements.txt        # 项目依赖库
├── pytest.ini              # Pytest 配置文件
└── README.md               # 本文档
```

## 🚀 如何使用

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

### 2. 运行回测

通过命令行运行主程序，程序将提示您输入回测所需的参数。
```bash
python turtle_trading/src/main.py
```
程序将引导您输入股票代码、回测时间范围、初始资金等参数，运行结束后，会输出完整的策略信号、回测绩效报告和交易记录。

支持多股票输入，多个股票代码请用逗号分隔，例如：
```bash
AAPL,GOOGL,TSLA
```

### 3. 运行测试

运行单元测试以确保所有模块正常工作：
```bash
pytest
```